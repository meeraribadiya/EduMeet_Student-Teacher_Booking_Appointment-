<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EduBook Control Panel</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script type="module" src="../../assets/js/utils.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --warning: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-approved {
            background: #dcfce7;
            color: #166534;
        }

        .badge-pending {
            background: #fef9c3;
            color: #854d0e;
        }

        .sidebar-link.active {
            background: var(--primary);
            color: white !important;
            border-radius: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        table tr:hover {
            background-color: #f8fafc;
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>

    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="window.toggleSidebar()" aria-label="Toggle Sidebar">
        <span></span>
    </button>
    <div class="sidebar-backdrop" onclick="window.toggleSidebar()"></div>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Admin Panel</h3>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="sidebar-link active" data-tab="dashboard">Overview</a></li>
                <li><a href="#" class="sidebar-link" data-tab="teachers">Manage Teachers</a></li>
                <li><a href="#" class="sidebar-link" data-tab="students">Student Approvals</a></li>
                <li><a href="#" class="sidebar-link" data-tab="messages">User Messages</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div id="dashboard" class="tab-content active">
                <h1 class="mb-4">System Overview</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card shadow-sm">
                        <h3 class="text-muted text-sm">Active Teachers</h3>
                        <p id="total-teachers" class="text-3xl font-bold text-primary">0</p>
                    </div>
                    <div class="card shadow-sm">
                        <h3 class="text-muted text-sm">Pending Students</h3>
                        <p id="pending-students" class="text-3xl font-bold text-warning">0</p>
                    </div>
                    <div class="card shadow-sm">
                        <h3 class="text-muted text-sm">Total Users</h3>
                        <p id="total-users" class="text-3xl font-bold text-info">0</p>
                    </div>
                </div>
            </div>

            <div id="teachers" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h1>Teacher Management</h1>
                </div>

                <div class="card shadow-sm p-0 overflow-hidden">
                    <div class="table-wrapper">
                        <table style="width:100%; border-collapse: collapse; min-width: 600px;">
                            <thead class="bg-light">
                                <tr style="text-align:left;">
                                    <th class="p-4">Profile</th>
                                    <th class="p-4">Subject/Bio</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="students" class="tab-content">
                <h1 class="mb-4">New Registrations</h1>
                <div class="card shadow-sm p-0 overflow-hidden">
                    <div class="table-wrapper">
                        <table style="width:100%; border-collapse: collapse; min-width: 600px;">
                            <thead>
                                <tr style="text-align:left;">
                                    <th class="p-4">Student</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="messages" class="tab-content">
                <h1 class="mb-4">Contact Messages</h1>
                <div class="card shadow-sm p-0 overflow-hidden">
                    <div class="table-wrapper">
                        <table style="width:100%; border-collapse: collapse; min-width: 700px;">
                            <thead>
                                <tr style="text-align:left;">
                                    <th class="p-4">User Details</th>
                                    <th class="p-4">Subject & Message</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="message-list-body">
                                <tr>
                                    <td colspan="4" class="p-8 text-center text-muted">Checking for messages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-modal" class="modal">
        <div class="card" style="width:100%; max-width:500px; border-radius:15px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl">Admin: Edit Profile</h3>
                <button onclick="closeModal()"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <form id="admin-edit-form">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                    <label class="form-label font-bold text-xs uppercase">Teacher Name</label>
                    <input type="text" id="edit-name" class="form-input" required>
                </div>
                <div class="mb-3">
                    <label class="form-label font-bold text-xs uppercase">Expertise/Subject</label>
                    <input type="text" id="edit-subject" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label class="form-label font-bold text-xs uppercase">Teacher Bio (Public)</label>
                    <textarea id="edit-bio" class="form-input" rows="4"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" id="save-btn" class="btn btn-primary flex-1">Update Teacher Info</button>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { onSnapshot, collection, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { renderNavbar, db, auth } from '../../assets/js/utils.js';

        renderNavbar();

        // Check if Admin
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    loadRealtimeData();
                } else {
                    alert("Unauthorized Access!");
                    window.location.href = "../../index.html";
                }
            } else {
                window.location.href = "../../auth/login.html";
            }
        });

        // Sidebar Toggle Logic
        window.toggleSidebar = () => {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-backdrop').classList.toggle('active');
            const toggleBtn = document.querySelector('.sidebar-toggle');
            if (toggleBtn) toggleBtn.classList.toggle('open');
        };

        // Tab Switching
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(link.dataset.tab).classList.add('active');
            };
        });

        // Load Data
        function loadRealtimeData() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const teachers = users.filter(u => u.role === 'teacher');
                const students = users.filter(u => u.role === 'student');

                document.getElementById('total-teachers').textContent = teachers.length;
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('pending-students').textContent = students.filter(s => !s.isApproved).length;

                renderTeachers(teachers);
                renderStudents(students);
            });

            // Contact Messages Snapshot
            onSnapshot(collection(db, "contact_messages"), (snapshot) => {
                const messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMessages(messages);
            });
        }

        function renderMessages(list) {
            const tbody = document.getElementById('message-list-body');
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-muted">No messages found.</td></tr>';
                return;
            }

            // Sort by timestamp (newest first)
            list.sort((a, b) => {
                const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                return timeB - timeA;
            });

            tbody.innerHTML = list.map(m => {
                const statusClass = m.status === 'new' ? 'badge-pending' : 'badge-approved';
                const statusText = m.status === 'new' ? 'Unread' : 'Closed';

                const timeStr = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleString() : 'Just now';

                return `
                <tr class="border-b">
                    <td class="p-4" data-label="User Details">
                        <div class="font-bold">${m.name}</div>
                        <div class="text-xs text-muted">${m.email}</div>
                        <div class="text-xs font-semibold uppercase text-primary">${m.role || 'guest'}</div>
                    </td>
                    <td class="p-4" data-label="Subject & Message">
                        <div class="text-sm font-bold">${m.subject}</div>
                        <div class="text-xs text-muted mb-2" style="word-break: break-word;">${m.message}</div>
                        <div class="text-xs italic text-main">${timeStr}</div>
                    </td>
                    <td class="p-4" data-label="Status">
                        <span class="badge ${statusClass}">${statusText}</span>
                    </td>
                    <td class="p-4 text-right" data-label="Actions">
                        <div class="btn-group" style="justify-content: flex-end; gap: 0.5rem;">
                            <a href="mailto:${m.email}?subject=Re: ${m.subject}" class="btn btn-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #10b981; border-color: #10b981;">Reply</a>
                            ${m.status === 'new' ? `<button class="btn btn-primary btn-sm close-msg-btn" data-id="${m.id}" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Mark as Fixed</button>` : ''}
                            <button class="btn btn-secondary btn-sm delete-msg-btn" data-id="${m.id}" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // Add Event Listeners
            tbody.querySelectorAll('.close-msg-btn').forEach(btn => {
                btn.onclick = async () => {
                    await updateDoc(doc(db, "contact_messages", btn.dataset.id), { status: 'closed' });
                };
            });

            tbody.querySelectorAll('.delete-msg-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (confirm("Delete this message?")) {
                        await deleteDoc(doc(db, "contact_messages", btn.dataset.id));
                    }
                };
            });
        }

        function renderTeachers(list) {
            document.getElementById('teacher-list-body').innerHTML = list.map(t => `
            <tr class="border-b">
                <td class="p-4" data-label="Profile">
                    <div class="font-bold">${t.name}</div>
                    <div class="text-xs text-muted">${t.email}</div>
                </td>
                <td class="p-4" data-label="Subject/Bio">
                    <div class="text-sm font-bold text-primary">${t.subject || 'Not Set'}</div>
                    <div class="text-xs text-muted" style="word-break: break-word;">${t.bio || 'No bio'}</div>
                </td>
                <td class="p-4" data-label="Actions">
                    <div class="btn-group" style="flex-direction: column; gap: 0.5rem; width: 100%;">
                        <button class="btn btn-primary btn-sm edit-btn" data-id="${t.id}" style="width: 100%;">Edit Info</button>
                        <button class="btn btn-secondary btn-sm delete-btn" data-id="${t.id}" style="width: 100%;">Remove</button>
                    </div>
                </td>
            </tr>
        `).join('');

            // Action Listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = () => openEditModal(btn.dataset.id);
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = () => deleteUser(btn.dataset.id);
            });
        }

        function renderStudents(list) {
            const tbody = document.getElementById('student-list-body');
            tbody.innerHTML = list.map(s => `
            <tr class="border-b">
                <td class="p-4" data-label="Student">
                    <div class="font-bold">${s.name}</div>
                    <div class="text-xs text-muted">${s.email}</div>
                </td>
                <td class="p-4" data-label="Status"><span class="badge ${s.isApproved ? 'badge-approved' : 'badge-pending'}">${s.isApproved ? 'Active' : 'Pending'}</span></td>
                <td class="p-4" data-label="Action">
                    <div class="btn-group" style="flex-direction: column; gap: 0.5rem; width: 100%;">
                        ${!s.isApproved ? `<button class="btn btn-primary btn-sm approve-btn" data-id="${s.id}" style="width: 100%;">Approve</button>` : ''}
                        <button class="btn btn-secondary btn-sm delete-btn" data-id="${s.id}" style="width: 100%;">Delete</button>
                    </div>
                </td>
            </tr>
        `).join('');

            tbody.querySelectorAll('.approve-btn').forEach(btn => {
                btn.onclick = async () => {
                    try {
                        await updateDoc(doc(db, "users", btn.dataset.id), { isApproved: true });
                    } catch (err) {
                        alert("Error approving student: " + err.message);
                    }
                };
            });

            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (confirm("Are you sure you want to delete this student? This action cannot be undone.")) {
                        try {
                            await deleteDoc(doc(db, "users", btn.dataset.id));
                            alert("Student deleted successfully!");
                        } catch (err) {
                            alert("Error deleting student: " + err.message);
                        }
                    }
                };
            });
        }

        // Modal Operations
        async function openEditModal(id) {
            const snap = await getDoc(doc(db, "users", id));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-name').value = data.name || '';
                document.getElementById('edit-subject').value = data.subject || '';
                document.getElementById('edit-bio').value = data.bio || '';
                document.getElementById('edit-modal').style.display = 'flex';
            }
        }

        window.closeModal = () => document.getElementById('edit-modal').style.display = 'none';

        document.getElementById('admin-edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;

            try {
                await updateDoc(doc(db, "users", id), {
                    name: document.getElementById('edit-name').value,
                    subject: document.getElementById('edit-subject').value,
                    bio: document.getElementById('edit-bio').value
                });
                alert("Teacher updated successfully!");
                closeModal();
            } catch (err) {
                alert("Update Failed: " + err.message);
            } finally {
                saveBtn.disabled = false;
            }
        };

        async function deleteUser(id) {
            if (confirm("Are you sure? This cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, "users", id));
                    alert("User deleted successfully!");
                } catch (err) {
                    alert("Error deleting user: " + err.message);
                }
            }
        }
    </script>
</body>

</html>