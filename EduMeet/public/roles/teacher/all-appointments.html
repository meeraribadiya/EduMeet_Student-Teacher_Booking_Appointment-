<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Appointments - Teacher - EduBook</title>
    <link rel="stylesheet" href="../../assets/css/style.css" />
    <script type="module" src="../../assets/js/utils.js"></script>
    <style>
        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-approved {
            background: #d4edda;
            color: #155724;
        }

        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        tr:hover {
            background-color: #fbfbfb;
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>

    <main class="container" style="padding: 2rem 0;">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1>Appointment History</h1>
                <p class="text-muted text-sm">Review all past and present session records.</p>
            </div>
            <div class="btn-group">
                <a class="btn btn-secondary btn-sm" href="teacher.html">Back to Dashboard</a>
            </div>
        </header>

        <div class="card shadow-sm">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="p-4">Student Details</th>
                            <th class="p-4">Session Date</th>
                            <th class="p-4">Time</th>
                            <th class="p-4">Agenda & Link</th>
                            <th class="p-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <tr>
                            <td colspan="5" class="p-8 text-center text-muted">
                                Loading appointment history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { db, auth, renderNavbar, requireAuth } from '../../assets/js/utils.js';
        import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Security check: Teacher only
        requireAuth('teacher');
        renderNavbar();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadHistory(user.uid);
            }
        });

        /**
         * Real-time history fetching
         */
        let allAppointments = [];
        let filtersInitialized = false;

        /**
         * Real-time history fetching
         */
        function loadHistory(teacherId) {
            const q = query(collection(db, "appointments"), where("teacherId", "==", teacherId));

            onSnapshot(q, (snapshot) => {
                allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!filtersInitialized) {
                    initFilters();
                    filtersInitialized = true;
                }
                filterAndRender();
            }, (error) => {
                console.error(error);
                document.getElementById('tbody').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-muted" style="display: block; width: 100%;">Error loading history.</td></tr>';
            });
        }

        function initFilters() {
            const card = document.querySelector('.card');
            const filterContainer = document.createElement('div');
            filterContainer.style.cssText = 'display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; width: 100%;';

            filterContainer.innerHTML = `
                <div style="flex: 1; min-width: 200px;">
                    <input type="text" id="searchInput" placeholder="Search by student..." style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <select id="statusFilter" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select id="timeFilter" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">All Time</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="past">Past</option>
                    </select>
                    <select id="dateFilter" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="last7">Last 7 Days</option>
                        <option value="custom">Custom</option>
                    </select>
                    <span id="customDateInputs" style="display: none; gap: 0.5rem;">
                        <input type="date" id="startDate" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="endDate" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                    </span>
                    <select id="sortOrder" style="padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="upcoming">Upcoming First</option>
                    </select>
                </div>
            `;

            card.parentNode.insertBefore(filterContainer, card);

            // Event Listeners
            const inputs = ['searchInput', 'statusFilter', 'timeFilter', 'dateFilter', 'sortOrder', 'startDate', 'endDate'];
            inputs.forEach(id => document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', filterAndRender));

            document.getElementById('dateFilter').addEventListener('change', (e) => {
                document.getElementById('customDateInputs').style.display = e.target.value === 'custom' ? 'flex' : 'none';
            });
        }

        function filterAndRender() {
            const tbody = document.getElementById('tbody');
            if (!allAppointments.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-muted" style="display: block; width: 100%;">No appointment history found.</td></tr>';
                return;
            }

            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const timeVal = document.getElementById('timeFilter').value;
            const dateVal = document.getElementById('dateFilter').value;
            const sort = document.getElementById('sortOrder').value;

            const now = new Date();
            const todayCommon = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            let filtered = allAppointments.filter(data => {
                const studentName = (data.studentName || '').toLowerCase();
                const appStatus = (data.status || 'pending').toLowerCase();
                const appDateStr = `${data.date} ${data.time}`;
                const appDate = new Date(appDateStr);
                const appTimestamp = appDate.getTime();
                const appDateOnly = new Date(appDate.getFullYear(), appDate.getMonth(), appDate.getDate()).getTime();

                if (search && !studentName.includes(search)) return false;

                // Status check including explicit 'completed'
                if (status !== 'all' && appStatus !== status) return false;

                if (timeVal === 'upcoming' && appTimestamp < now.getTime()) return false;
                if (timeVal === 'past' && appTimestamp >= now.getTime()) return false;

                if (dateVal === 'today') {
                    if (appDateOnly !== todayCommon) return false;
                } else if (dateVal === 'last7') {
                    const sevenDaysAgo = todayCommon - (7 * 24 * 60 * 60 * 1000);
                    if (appTimestamp < sevenDaysAgo || appTimestamp > now.getTime()) return false;
                } else if (dateVal === 'custom') {
                    const s = document.getElementById('startDate').value;
                    const e = document.getElementById('endDate').value;
                    if (s) {
                        const startTs = new Date(s).setHours(0, 0, 0, 0);
                        if (appTimestamp < startTs) return false;
                    }
                    if (e) {
                        const endTs = new Date(e).setHours(23, 59, 59, 999);
                        if (appTimestamp > endTs) return false;
                    }
                }

                return true;
            });

            filtered.sort((a, b) => {
                const dA = new Date(`${a.date} ${a.time}`);
                const dB = new Date(`${b.date} ${b.time}`);

                if (sort === 'newest') return dB - dA;
                if (sort === 'oldest') return dA - dB;
                if (sort === 'upcoming') return dA - dB;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-muted" style="display: block; width: 100%;">No records match your filters.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(a => {
                const badgeClass = a.status === 'approved' ? 'badge-approved' :
                    (a.status === 'pending' ? 'badge-pending' :
                        (a.status === 'rejected' ? 'badge-rejected' : 'badge-approved'));

                const displayStatus = a.status === 'completed' ? 'Completed' : a.status;
                const badgeStyle = a.status === 'completed' ? 'background-color: #6c757d; color: white;' : '';

                return `
                    <tr style="border-bottom:1px solid var(--border-color);">
                        <td class="p-4" data-label="Student Details">
                            <div class="font-bold">${a.studentName}</div>
                            <div class="text-xs text-muted">${a.studentEmail || 'N/A'}</div>
                        </td>
                        <td class="p-4" data-label="Session Date">${a.date}</td>
                        <td class="p-4" data-label="Time"><span class="font-bold text-main">${a.time}</span></td>
                        <td class="p-4" data-label="Agenda & Link">
                            <div class="text-sm" style="word-break: break-word;" title="${a.description || a.message}">
                                ${a.description || a.message || '<span class="italic text-muted">No topic</span>'}
                            </div>
                            ${a.meetingLink ? `
                                <div class="mt-2">
                                    <a href="${a.meetingLink}" target="_blank" class="btn btn-primary btn-sm" style="font-size: 0.8rem; padding: 0.4rem 1rem;min-height: auto;">
                                        ðŸ”— Join Session
                                    </a>
                                </div>` : ''}
                        </td>
                        <td class="p-4" data-label="Status"><span class="badge ${badgeClass}" style="${badgeStyle}">${displayStatus}</span></td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>

</html>