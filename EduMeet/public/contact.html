<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact - EduBook</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script type="module" src="assets/js/utils.js"></script>
</head>

<body>
  <div id="navbar-container"></div>
  <main class="container" style="padding: 3rem 0;">
    <h1 class="mb-6" style="font-size: 2.5rem; font-weight: 800;">Contact Us</h1>
    <div class="card" style="max-width: 600px; margin: 0 auto;">
      <form id="contact-form">
        <div class="form-group" style="margin-bottom: 1.25rem;">
          <label class="form-label">Full Name</label>
          <input type="text" id="contact-name" class="form-input" placeholder="Your name" required />
        </div>
        <div class="form-group" style="margin-bottom: 1.25rem;">
          <label class="form-label">Your Actual Email Address</label>
          <input type="email" id="contact-email" class="form-input" placeholder="your@email.com" required />
        </div>
        <div class="form-group" style="margin-bottom: 1.25rem;">
          <label class="form-label">I am a...</label>
          <select id="contact-role" class="form-input" required>
            <option value="" disabled selected>Select your role</option>
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="guest">Guest / Other</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 1.25rem;">
          <label class="form-label">Subject</label>
          <input type="text" id="contact-subject" class="form-input" placeholder="What is this about?" required />
        </div>
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label class="form-label">Message</label>
          <textarea id="contact-message" class="form-input" rows="5" placeholder="Write your message here..." required
            style="resize: vertical;"></textarea>
        </div>
        <button type="submit" id="submit-btn" class="btn btn-primary" style="width: 100%;">Send Message</button>
      </form>
      <div id="success-msg"
        style="display: none; margin-top: 1rem; padding: 1rem; background: #dcfce7; color: #166534; border-radius: 8px; text-align: center;">
        Your message has been sent to the admin. We will get back to you soon!
      </div>
    </div>
  </main>
  <script type="module">
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { renderNavbar, getCurrentUser, db } from './assets/js/utils.js';

    // Auto-fill form if user is logged in
    const user = getCurrentUser();
    if (user) {
      document.getElementById('contact-name').value = user.name || '';
      document.getElementById('contact-email').value = user.email || '';
      document.getElementById('contact-role').value = user.role ? user.role.toLowerCase() : '';
    }

    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const successMsg = document.getElementById('success-msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('contact-name').value;
      const email = document.getElementById('contact-email').value;
      const role = document.getElementById('contact-role').value;
      const subject = document.getElementById('contact-subject').value;
      const message = document.getElementById('contact-message').value;

      // Basic Validation (HTML5 handles most, but extra check for email format)
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert("Please enter a valid email address.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Sending...";

      try {
        await addDoc(collection(db, "contact_messages"), {
          name,
          email,
          role,
          subject,
          message,
          status: 'new',
          timestamp: serverTimestamp(),
          userId: user ? user.id : 'guest'
        });

        successMsg.style.display = 'block';
        form.style.display = 'none';

        setTimeout(() => {
          successMsg.style.display = 'none';
          form.style.display = 'block';
          form.reset();
          submitBtn.disabled = false;
          submitBtn.textContent = "Send Message";
        }, 5000);

      } catch (error) {
        console.error("Error sending message:", error);
        alert("Failed to send message. Please try again later.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Send Message";
      }
    });
  </script>
</body>

</html>